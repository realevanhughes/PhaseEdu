<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix"></script>
</head>
<body>
    <form method="get" action="/internal/logout">
        <button type="submit">Logout</button>
    </form>
    <div>
        <canvas id="myChart" width="400" height="100"></canvas>
    </div>
    <div>
        <canvas id="heatmap" width="1200" height="400"></canvas>
    </div>
</body>
<script>
    const ctx1 = document.getElementById('myChart');

    let xhr = new XMLHttpRequest();
    xhr.open('GET', "/api/points/dict", false);
    xhr.send(null);

    const rawData = JSON.parse(xhr.responseText);

    const chartData = {
        labels: Object.keys(rawData),
        datasets: [{
            label: 'Points',
            data: Object.values(rawData).map(item => item[0])
        }]
    };

    new Chart(ctx1, {
        type: 'bar',
        data: chartData,
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                colors: {
                    enabled: true
                }
            }
        }
    });

    fetch("/api/periods")
        .then((response) => response.json())
        .then((json) => console.log(json));

    (async () => {
        // 1. Fetch from your backend API
        const res = await fetch("/api/presence/dict");
        const { data: apiData } = await res.json(); // unwrap { data: [...] }

        // 2. Extract unique days and hours
        const days = [...new Set(apiData.map(d => d.day))].sort();
        const periods = [...new Set(apiData.map(d => d.period))].sort();

        // 3. Map states to colors
        const stateColors = {
            present: "#4caf50",
            late: "#ff9800",
            excused: "#2196f3",
            absent: "#f44336"
        };
        const getColor = (state) => stateColors[state] || "#ccc";

        // 4. Transform into matrix points
        const points = apiData.map(d => ({ x: d.day, y: d.period, v: d.state}));

        // 5. Render Chart.js heatmap
        const ctx = document.getElementById("heatmap").getContext("2d");

        ctx.canvas.style.width = "100%";
        ctx.canvas.style.height = "420px";

        const GAP = 2;

        new Chart(ctx, {
            type: "matrix",
            data: {
                datasets: [{
                    label: "User presence",
                    data: points,
                    backgroundColor: (ctx) => getColor(ctx.raw.v),
                    width: ({ chart }) => {
                        const ca = chart.chartArea;
                        if (!ca) return 10;
                        return Math.max((ca.width / days.length) - GAP, 1);
                    },
                    height: ({ chart }) => {
                        const ca = chart.chartArea;
                        if (!ca) return 10;
                        return Math.max((ca.height / hours.length) - GAP, 1);
                    },
                    borderRadius: 3
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: "category",
                        labels: days,
                        offset: true,
                        title: { display: true, text: "Day" },
                        grid: { display: false }
                    },
                    y: {
                        type: "category",
                        labels: hours,
                        offset: true,
                        reverse: true, // puts 00:00 at top
                        title: { display: true, text: "Hour" },
                        grid: { display: false }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: (items) => {
                                const d = items[0].raw;
                                return `${d.x} @ ${d.y}`;
                            },
                            label: (ctx) => {
                                const d = ctx.raw;
                                return `State: ${d.v}`;
                            }
                        }
                    },
                    legend: { display: false }
                }
            }
        });
    })();

</script>
</html>